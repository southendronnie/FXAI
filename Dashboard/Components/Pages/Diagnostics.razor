@using TradingDashboard.Models
@using TradingDashboard.Services
@inject IJSRuntime JS
@inject ApiClient Api

<div id="candleChart" style="height: 400px;"></div>

@code {
    [Parameter] public string Timeframe { get; set; } = "1m";
    List<TradingDashboard.Models.Candle> candles = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var end = DateTime.UtcNow;
            var start = end.AddMinutes(-60);
            var apiCandles = await Api.GetCandles(Timeframe, start, end);

            // Explicitly convert the list to the correct type
            candles = apiCandles.Select(c => new TradingDashboard.Models.Candle
            {
                Time = c.Time,
                Open = c.Open,
                High = c.High,
                Low = c.Low,
                Close = c.Close
            }).ToList();

            var jsData = candles.Select(c => new object[]
            {
                new DateTimeOffset(c.Time).ToUnixTimeMilliseconds(),
                (double)c.Open,
                (double)c.High,
                (double)c.Low,
                (double)c.Close
            }).ToList();

            await JS.InvokeVoidAsync("renderCandleChart", "candleChart", jsData);
        }
    }
}